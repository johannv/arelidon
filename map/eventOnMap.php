<?php/** Commentaire sur la gestion des calques sur le jeu  *  * Z-index : importance des filtres  *  * 1 : personnage *  * 2 : pnj *  * 3 : autres joueurs (pour qu'il se place devant le monstre) *  * 4 : monstres *  * 5 : obstacles et objets *  *  */if($_GET['refresh'] == 1){	if(@file('../../require.php'))		require_once('../../require.php');	elseif(@file('../require.php'))		require_once('../require.php');	elseif(@file('require.php'))		require_once('require.php');		}/*if($map->id < 1)	$map = new map($char->getMap());		*/?><div style="float:left;margin-top:0px;margin-left:0px;z-index:1;width:0px;">	<table cellspacing="0" cellpadding="0" style="border:0px;z-index:1;"><tr style="border:0px;height:32px;width:32px;">	<?php	// Données du personnage	$casechar = ($char->getOrd() - 1) * 25 + $char->getAbs(); 			// Chargement des cases bloquée	$arrayCase = array();	$sql = "SELECT abs,ord FROM `map` WHERE map = '".$char->getMap()."' && bloc = '1'";	$do = loadSqlResultArrayList($sql);	foreach($do as $result)	{		$number = ($result['ord'] - 1) * 25 + $result['abs'];		$arrayCase[$number] = '1';	}			// Chargement des téléporteurs		$arrayWP = map::getAllTelep($char->getMap());		// Chargement des coffres		$arrayBox = array();	$sql = "SELECT id,abs,ord FROM `tresor` WHERE map = '".$char->getMap()."' ";	$do = loadSqlResultArrayList($sql);		foreach($do as $result)	{		$number = ($result['ord'] - 1) * 25 + $result['abs'];		$arrayBox[$number] = $result['id'];		$arrayCase[$number] = '1'; // Un coffre block le passage	}	// Chargement des monstres		$arrayMstr = array();	$timerespawn = time();	$monsterList = monster::getAllMonstersOnMap($char->getMap(),$timerespawn);		foreach($monsterList as $monster)	{		$number = ($monster['ord'] - 1) * 25 + $monster['abs'];		$arrayCase[$number] = '1';				$arrayMonster[] = array('id'=>$monster['id'],'abs'=>$monster['abs'],'ord'=>$monster['ord'],'taille'=>$monster['taille'],'idmstr'=>$monster['idmstr']);			// pour les monstres tailles humaines		if($monster['taille'] == 2)		{			$number = ($monster['ord'] - 2) * 25 + $monster['abs'];			$arrayCase[$number] = '1';		}				// pour les monstres tailles serpent ^^		if($monster['taille'] == 3)		{			$number = ($monster['ord'] - 1) * 25 + $monster['abs'] + 1;			$arrayCase[$number] = '1';		}						// Pour les gros monstres ^^		if($monster['taille'] == 4)		{			$number = ($monster['ord'] - 1) * 25 + $monster['abs'] + 1;			$arrayCase[$number] = '1';			$number = ($monster['ord'] - 2) * 25 + $monster['abs'] + 1;			$arrayCase[$number] = '1';			$number = ($monster['ord'] - 2) * 25 + $monster['abs'];			$arrayCase[$number] = '1';		}	}		// Chargement des PNJ	$pnjList = pnj::getAllPnjOnMap($char->getMap());	foreach($pnjList as $pnj)	{				// taille 1		$number = ($pnj['ord'] - 1) * 25 + $pnj['abs'];		$arrayCase[$number] = '1';				if($pnj['taille'] == 2)		{			$number = ($pnj['ord'] - 2) * 25 + $pnj['abs'];			$arrayCase[$number] = '1';						$arrayPnj[] = array('id'=>$pnj['id'],'abs'=>$pnj['abs'],'ord'=>$pnj['ord'],'taille'=>$pnj['taille'],'image'=>$pnj['image']);		}				// taille 3 (horizontale)		if($pnj['taille'] == 3)		{			$number = ($pnj['ord'] - 1) * 25 + $pnj['abs'] + 1;			$arrayCase[$number] = '1';						$arrayPnj[] = array('id'=>$pnj['id'],'abs'=>$pnj['abs'],'ord'=>$pnj['ord'],'taille'=>$pnj['taille'],'image'=>$pnj['image']);		}				// taille 4 (carré)		if($pnj['taille'] == 4)		{			$number = ($pnj['ord'] - 1) * 25 + $pnj['abs'] + 1;			$arrayCase[$number] = '1';			$number = ($pnj['ord'] - 2) * 25 + $pnj['abs'] + 1;			$arrayCase[$number] = '1';			$number = ($pnj['ord'] - 2) * 25 + $pnj['abs'];			$arrayCase[$number] = '1';						$arrayPnj[] = array('id'=>$pnj['id'],'abs'=>$pnj['abs'],'ord'=>$pnj['ord'],'taille'=>$pnj['taille'],'image'=>$pnj['image']);		}	}	// Chargement des ressources	$sql = "SELECT id,abs,ord,action_id FROM `metier_ressource` WHERE map = ".$char->getMap()." && time <= ".time();	$ressources = loadSqlResultArrayList($sql);		foreach($ressources as $ressource)	{		$number = ($ressource['ord'] - 1) * 25 + $ressource['abs'];		$arrayCase[$number] = '1';	}		// Chargement des obstacles		$obstacles = map::getAllObstaclesOnMap($char->getMap(),$char);	foreach($obstacles as $obstacle)	{		// taille 1		$number = ($obstacle['ord'] - 1) * 25 + $obstacle['abs'];		$arrayCase[$number] = '1';		// taille 2		if($obstacle['taille'] == 2)		{			$number = ($obstacle['ord'] - 2) * 25 + $obstacle['abs'];			$arrayCase[$number] = '1';		}				// taille 3 (horizontale)		if($obstacle['taille'] == 3)		{			$number = ($obstacle['ord'] - 1) * 25 + $obstacle['abs'] + 1;			$arrayCase[$number] = '1';		}						// taille 4 (carré)		if($obstacle['taille'] == 4)		{			$number = ($obstacle['ord'] - 1) * 25 + $obstacle['abs'] + 1;			$arrayCase[$number] = '1';			$number = ($obstacle['ord'] - 2) * 25 + $obstacle['abs'] + 1;			$arrayCase[$number] = '1';			$number = ($obstacle['ord'] - 2) * 25 + $obstacle['abs'];			$arrayCase[$number] = '1';		}	}			// Chargement des autres joueurs	$players_online = char::getPlayersOnlineOnMap($char);	foreach($players_online as $player)	{		$number = ($player['ord'] - 2) * 25 + $player['abs'];		$arrayCase[$number] = '1';		$number = ($player['ord'] - 1) * 25 + $player['abs'];		$arrayCase[$number] = '1';	}		// Chargement des boites aux lettres		$sql = "SELECT id,abs,ord FROM `trade_box` WHERE map = '".$char->getMap()."' ";	$do = loadSqlResultArrayList($sql);		foreach($do as $result)	{		$number = ($result['ord'] - 1) * 25 + $result['abs'];		$arrayCase[$number] = '1';	}//#######################################################################################################// Affichage des cases bloquées sur la carte		$case = 0;	$teleponcase = 0;	$boxoncase = 0;		while ($case < 375) {			$case = $case + 1	;			$ord = $case/25 ;		$ord = floor($ord) ;		$abs = $case - ($ord*25) ;		$ord = $ord + 1 ;		 		 if ($abs == 0) {		 $abs = 25 ;		 $ord = $ord - 1 ;		 }				$marginTop = ($ord - 1) * 32 - 16 ;		$marginLeft = ($abs - 1) * 32;				if($marginTop == 432)		{			$marginTop = 430;			}				if (ereg("MSIE", $_SERVER["HTTP_USER_AGENT"])) {		    $time = 2;		} else if (ereg("^Mozilla/", $_SERVER["HTTP_USER_AGENT"])) {		    $time = 9;		} else if (ereg("^Opera/", $_SERVER["HTTP_USER_AGENT"])) {			$time = 8;		}else{			$time = 10;		}		 $time = $time * 2;		 		if($arrayWP[$case]['changemap'] >= '1')		{			$teleponcase = 1;			$typetelep = $arrayWP[$case]['type'];			if($typetelep == 0)				$typetelep = 1;		}				if($arrayBox[$case] >= '1')		{			$boxoncase = $arrayBox[$case];		} 				if($arrayMonster[$case] >= '1')		{			$monsteroncase = $arrayMonster[$case];		} 				if($arrayPnj[$case] >= '1')		{			$pnjoncase = $arrayPnj[$case];		} 		 		 ?>		 <td style="border:0px;width:32px;height:32px;" valign="top">			<div style="width:32px;height:32px;border:0px;">								<?php $number = ($ord - 1) * 25 + $abs; ?>								<div id="free<?php echo $number; ?>" style="display:none;text-align:center;"><?php echo $arrayCase[$case]; ?></div>						<?php					if($teleponcase == '1')				{					echo '<img class="POM" src="pictures/telep/'.$typetelep.'.png" alt="Téléporteur" style="z-index:2;text-align:center;margin:5px;" />';					echo '<div id="telep'.$number.'" style="display:none">1</div>';				}								if($boxoncase >= 1)				{										$a = $abs - $char->getAbs(); // écart horizontale					$b = $ord - $char->getOrd(); // écart verticale					$distance = abs($a) + abs($b);					// Valeur absolue du résultat					if(abs($a) <= 1 && abs($b) <= 1)					{						$distance = 1;					}															$box = new box($boxoncase);					if($box->isOpenned($char->getId()))					{						$picture = "pictures/coffre/".$box->getImg()."_open.gif";					}else{						$picture = "pictures/coffre/".$box->getImg()."_close.gif";						}					echo '<div class="POM"><img  src="'.$picture.'" alt="Trésors" onclick="loadObject(\'coffre\',\''.$distance.'\',\''.$boxoncase.'\');" /></div>';				}								if($monsteroncase >= 1)				{										$a = $abs - $char->getAbs(); // écart horizontale					$b = $ord - $char->getOrd(); // écart verticale						// Valeur absolue du résultat					$distance = abs($a) + abs($b);										if(abs($a) <= 1 && abs($b) <= 1)					{						$distance = 1;					}						if ($arrayMonster['idmstr'] >=1)						echo '<div class="POM"><img  src="pictures/monster/'.$arrayMonster['idmstr'].'.gif" alt="Monstres" onclick="loadObject(\'monster\',\''.$distance.'\',\''.$monsteroncase.'\');"  /></div>';				}				?>					</div>		</td>		 		 		 <?php				$teleponcase = 0;		$boxoncase = 0;		$monsteroncase = 0;				 if ($abs == 25) { // si fin colone		 	echo "</tr>" ;		 	if ($ord < 16) { // si fin ligne		 		echo '<tr style="height:32px;">' ;		  		if($ord == 15)		  			echo '</tr>';		 	} else {		 		echo "</table>" ;		 	} // fin si fin hé hé	 		} // fin si on change de ligne	} 	 	?>	</table></div><?php$compte = 1;// Affichage des objets sur la carte	$sql = "SELECT * FROM `objetonmap` WHERE map = ".$char->getMap();	$array_item = loadSqlResultArrayList($sql);		foreach($array_item as $item_id)	{		$compte++;		$item = new item($item_id['item_id']);		$itemMarginLeft = ($item_id['abs']  - 1) * 32;		$itemMarginTop = ($item_id['ord']  - 1) * 32;		$itemMoveTop = ($item_id['ord']  - 2) * 32;				$a = $abs - $item_id['abs']; // écart horizontale		$b = $ord - $item_id['ord']; // écart verticale		// Valeur absolue du résultat		$distance = abs($a) + abs($b);				$onclick =  "loadObject('player','$distance','".$char->getId()."');";		echo '<div onclick="'.$onclick.'" style="position:absolute;float:left;margin-left:'.$itemMarginLeft.'px;margin-top:'.$itemMarginTop.'px;width:32px;height:32px;z-index:'.$compte.';" alt="A">';			echo '<img src="pictures/item/'.$item->item.'.gif" alt="objet" title="'.$item->name.'" />';		echo '</div>';			}// 	Affichage des pnjif(count($arrayPnj)>=1){	foreach($arrayPnj as $pnj)	{		if($pnj['taille'] == 2)		{			$persoMarginTop = ($pnj['ord']  - 1) * 32 - 16;			$width='32';			$height='48';		}elseif($pnj['taille'] == 1)		{			$persoMarginTop = ($pnj['ord']  - 1) * 32;			$width='32';			$height='32';		}elseif($pnj['taille'] == 4)		{			$persoMarginTop = ($pnj['ord']  - 1) * 32 - 32;			$width='64';			$height='64';						$number = ($pnj['ord'] - 1) * 25 + $obstacle['abs'] + 1;			$arrayCase[$number] = '1';			$number = ($pnj['ord'] - 2) * 25 + $obstacle['abs'] + 1;			$arrayCase[$number] = '1';			$number = ($pnj['ord'] - 2) * 25 + $obstacle['abs'];			$arrayCase[$number] = '1';		}								$a = $pnj['abs'] - $char->getAbs(); // écart horizontale				// gestion de la taille du joueur		if($pnj['ord'] > $char->getOrd())			$char_ord = $char->getOrd() + 1;		else			$char_ord = $char->getOrd();					$b = $pnj['ord'] - $char_ord; // écart verticale		$distance = abs($a) + abs($b);				// Valeur absolue du résultat		if(abs($a) <= 1 && abs($b) <= 1)		{			$distance = 1;		}				$persoMarginLeft = ($pnj['abs'] - 1) * 32;				echo '<div id="pnj_'.$pnj['id'].'" onclick="loadObject(\'pnj\',\''.$distance.'\',\''.$pnj['id'].'\');" style="position:absolute;float:left;margin-left:'.$persoMarginLeft.'px;margin-top:'.$persoMarginTop.'px;height:'.$height.'px;width:'.$width.'px;background-repeat:no repeat;cursor:pointer;z-index:'.$compte.';">';			$name = pnj::getNameById($pnj['id']);			echo '<img src="pictures/pnj/'.$pnj['image'].'" alt="Xxx" title="'.$name.'" />';		echo '</div>';				$compte++;	}	}// Affichage des Monstres	if(count($arrayMonster)>=1){		foreach($arrayMonster as $monster)	{				if($monster['abs'] > 25){$monster['abs']=25;}		if($monster['abs'] < 0){$monster['abs']=0;}		if($monster['ord'] > 15){$monster['ord']=15;}		if($monster['ord'] < 0){$monster['ord']=0;}				$return_array = getMarginWitdhHeightByTaille($monster['taille'],$monster['abs'],$monster['ord']);				$persoMarginLeft = $return_array['marginLeft'];		$persoMarginTop = $return_array['marginTop'];		$width=$return_array['width'];		$height=$return_array['height'];		$distance = calculDistance($char->getAbs(),$char->getOrd(),$monster['abs'],$monster['ord'],$monster['taille']);		echo '<div id="monster_'.$monster['id'].'" onclick="loadObject(\'monster\',\''.$distance.'\',\''.$monster['id'].'\');" style="position:absolute;float:left;margin-left:'.$persoMarginLeft.'px;margin-top:'.$persoMarginTop.'px;background-image:url(pictures/monster/'.$monster['idmstr'].'.gif);height:'.$height.'px;width:'.$width.'px;background-repeat:no repeat;cursor:pointer;z-index:'.$compte.';"></div>';				$compte++;	}}// Gestion des ressources sur la carte	foreach($ressources as $ressource)	{				$persoMarginLeft = ($ressource['abs'] - 1) * 32;		$persoMarginTop = ($ressource['ord']  - 1) * 32;		$width='24';		$height='24';					$a = $ressource['abs'] - $char->getAbs(); // écart horizontale		$b = $ressource['ord'] - $char->getOrd(); // écart verticale		$distance = abs($a) + abs($b);		// Valeur absolue du résultat		if(abs($a) <= 1 && abs($b) <= 1)		{			$distance = 1;		}		$sql = "SELECT objet_id FROM `metier_action` WHERE id = ".$ressource['action_id'];		$item_id = loadSqlResult($sql);		$onclick =  "loadObject('action','$distance','".$ressource['id']."');";		echo '<div id="ressource_'.$item_id.'" onclick="'.$onclick.'" style="position:absolute;float:left;margin-left:'.$persoMarginLeft.'px;margin-top:'.$persoMarginTop.'px;background-image:url(pictures/item/'.$item_id.'.gif);height:'.$height.'px;width:'.$width.'px;background-repeat:no repeat;cursor:pointer;z-index:'.$compte.';">';		echo '</div>';		$compte++;	}	// Gestion des obstacles		foreach($obstacles as $obstacle)	{				$return_array = getMarginWitdhHeightByTaille($obstacle['taille'],$obstacle['abs'],$obstacle['ord']);				$persoMarginLeft = $return_array['marginLeft'];		$persoMarginTop = $return_array['marginTop'];		$width=$return_array['width'];		$height=$return_array['height'];					$a = $obstacle['abs'] - $char->getAbs(); // écart horizontale		$b = $obstacle['ord'] - $char->getOrd(); // écart verticale		$distance = abs($a) + abs($b);		// Valeur absolue du résultat		if(abs($a) <= 1 && abs($b) <= 1)		{			$distance = 1;		}		echo '<div id="obstacle_'.$obstacle['id'].'" onclick="" style="position:absolute;float:left;margin-left:'.$persoMarginLeft.'px;margin-top:'.$persoMarginTop.'px;background-image:url(pictures/obstacle/'.$obstacle['img'].');height:'.$height.'px;width:'.$width.'px;background-repeat:no repeat;cursor:pointer;z-index:'.$compte.';">';		echo '</div>';		$compte++;	}// Gestion des joueurs en ligne		foreach($players_online as $player)	{				$persoMarginLeft = ($player['abs'] - 1) * 32;		$persoMarginTop = ($player['ord']  - 1) * 32 - 16;		$width='32';		$height='48';					$a = $player['abs'] - $char->getAbs(); // écart horizontale		$b = $player['ord'] - $char->getOrd(); // écart verticale		$distance = abs($a) + abs($b);		// Valeur absolue du résultat		if(abs($a) <= 1 && abs($b) <= 1)		{			$distance = 1;		}				$face = $player['face'];		$player = new char($player['id']);		$onclick =  "loadObject('player','$distance','".$player->getId()."');";		echo '<div id="player_'.$player->getId().'" ' .				'onclick="'.$onclick.'" ' .				'style="position:absolute;' .				'float:left;' .				'margin-left:'.$persoMarginLeft.'px;' .				'margin-top:'.$persoMarginTop.'px;' .				'background-image:url('.$player->getUrlPicture('ico',$face).');' .				'height:'.$height.'px;' .				'width:'.$width.'px;' .				'background-repeat:no repeat;' .				'cursor:pointer;' .				'z-index:'.$compte.';">';		echo '</div>';		$compte++;	}// Gestion des interactions sur la carte	$interaction_array = interaction::getAllActionsOnMap($char->getMap());	foreach($interaction_array as $interaction)	{		$width='32';		$height='32';				$persoMarginLeft = ($interaction['abs'] - 1) * 32;		$persoMarginTop = ($interaction['ord']  - 1) * 32;				$a = $interaction['abs'] - $char->getAbs(); // écart horizontale		$b = $interaction['abs'] - $char->getOrd(); // écart verticale		$distance = abs($a) + abs($b);		// Valeur absolue du résultat		if(abs($a) <= 1 && abs($b) <= 1)		{			$distance = 1;		}				$onclick =  "loadObject('interaction','$distance','".$interaction['id']."');";				echo '<div id="interaction_'.$interaction['id'].'" ' .				'onclick="'.$onclick.'" ' .				'style="position:absolute;' .					'float:left;' .					'background-image:url(pictures/utils/interaction.png);' .					'margin-left:'.$persoMarginLeft.'px;' .					'margin-top:'.$persoMarginTop.'px;' .					'height:'.$height.'px;' .					'width:'.$width.'px;' .					'cursor:help;' .				'z-index:'.$compte.';" ' .				'>';		echo '</div>';				$compte++;	}// Gestion des ateliers sur la carte	$atelier_array = metier::getAtelierOnMap($char->getMap());	foreach($atelier_array as $atelier)	{		$width='32';		$height='32';				$persoMarginLeft = ($atelier['abs'] - 1) * 32;		$persoMarginTop = ($atelier['ord']  - 1) * 32;				$a = $atelier['abs'] - $char->getAbs(); // écart horizontale		$b = $atelier['abs'] - $char->getOrd(); // écart verticale		$distance = abs($a) + abs($b);		// Valeur absolue du résultat		if(abs($a) <= 1 && abs($b) <= 1)		{			$distance = 1;		}				$onclick =  "loadObject('atelier','$distance','".$atelier['id']."');";				echo '<div id="atelier_'.$atelier['id'].'" ' .				'onclick="'.$onclick.'" ' .				'style="position:absolute;' .					'float:left;' .					'margin-left:'.$persoMarginLeft.'px;' .					'margin-top:'.$persoMarginTop.'px;' .					'height:'.$height.'px;' .					'width:'.$width.'px;' .				'z-index:'.$compte.';" ' .				'>';		echo '<img src="pictures/utils/pp.png" alt="" />';		echo '</div>';				$compte++;	}// Gestion des boites aux lettres		$sql = "SELECT id,abs,ord FROM `trade_box` WHERE map = '".$char->getMap()."' ";	$do = loadSqlResultArrayList($sql);		foreach($do as $result)	{		$number = ($result['ord'] - 1) * 25 + $result['abs'];		$arrayCase[$number] = '1';				$width='32';		$height='32';				$persoMarginLeft = ($result['abs'] - 1) * 32;		$persoMarginTop = ($result['ord']  - 1) * 32;				$a = $result['abs'] - $char->getAbs(); // écart horizontale		$b = $result['abs'] - $char->getOrd(); // écart verticale		$distance = abs($a) + abs($b);		// Valeur absolue du résultat		if(abs($a) <= 1 && abs($b) <= 1)		{			$distance = 1;		}				$onclick =  "loadObject('box_letter','$distance','".$result['id']."');";				echo '<div id="box_letter_'.$result['id'].'" ' .				'onclick="'.$onclick.'" ' .				'style="position:absolute;' .					'float:left;' .					'margin-left:'.$persoMarginLeft.'px;' .					'margin-top:'.$persoMarginTop.'px;' .					'height:'.$height.'px;' .					'width:'.$width.'px;' .				'z-index:'.$compte.';" ' .				'>';		echo '<img src="pictures/utils/box_letter.gif" alt="" />';		echo '</div>';				$compte++;	}	#########################################################################################################	// Information sur le personnage à rechargerif($char->getLife() <= 0 && $char->getTimeDie() == 0){	$time_respawn = time() + 30;	$char->update('time_die',$time_respawn);}echo '<div id="life_perso" style="display:none;">';	echo $char->getLife();echo '</div>';		echo '<div id="die_perso" style="display:none;">';	$time = time();		$time_go_cimetery = $char->getTimeDie() - $time;	if($time_go_cimetery < 0)		$time_go_cimetery = 0;			echo $time_go_cimetery;echo '</div>';echo '<div id="time" style="display:none;">'.$time.'</div>';?>